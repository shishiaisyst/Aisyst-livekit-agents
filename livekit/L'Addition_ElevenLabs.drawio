<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36" version="29.4.0">
  <diagram name="ElevenLabs + L&#39;Addition POS Integration" id="architecture">
    <mxGraphModel dx="2036" dy="1562" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1920" pageHeight="1200" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="title" parent="1" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1" value="ElevenLabs + L&#39;Addition POS Integration Architecture" vertex="1">
          <mxGeometry height="40" width="600" x="660" y="20" as="geometry" />
        </mxCell>
        <mxCell id="phase1_bg" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1F5FE;strokeColor=#01579B;strokeWidth=2;dashed=1;dashPattern=8 8;" value="" vertex="1">
          <mxGeometry height="320" width="1550" x="40" y="80" as="geometry" />
        </mxCell>
        <mxCell id="phase1_title" parent="1" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1" value="PHASE 1: DURING CALL (Real-Time Order Submission)" vertex="1">
          <mxGeometry height="30" width="400" x="60" y="90" as="geometry" />
        </mxCell>
        <mxCell id="customer" parent="1" style="shape=actor;whiteSpace=wrap;html=1;fillColor=#FFE082;strokeColor=#F57F17;strokeWidth=2;" value="&lt;font style=&quot;font-size: 14px;&quot;&gt;Customer&lt;br&gt;Phone Call&lt;/font&gt;" vertex="1">
          <mxGeometry height="80" width="60" x="80" y="140" as="geometry" />
        </mxCell>
        <mxCell id="elevenlabs" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#B39DDB;strokeColor=#4527A0;strokeWidth=2;fontSize=12;fontStyle=1" value="ElevenLabs&#xa;Voice Agent&#xa;(Cerebras LLM)" vertex="1">
          <mxGeometry height="80" width="140" x="200" y="140" as="geometry" />
        </mxCell>
        <mxCell id="arrow1" edge="1" parent="1" source="customer" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#1976D2;" target="elevenlabs" value="1. Voice Call">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="tool_box" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#CE93D8;strokeColor=#6A1B9A;strokeWidth=2;fontSize=11;fontStyle=1" value="&lt;font style=&quot;font-size: 14px;&quot;&gt;Custom Tool:&lt;br&gt;submit_order_to_pos&lt;/font&gt;" vertex="1">
          <mxGeometry height="60" width="140" x="190" y="310" as="geometry" />
        </mxCell>
        <mxCell id="arrow2" edge="1" parent="1" source="elevenlabs" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#7B1FA2;dashed=1;" target="tool_box" value="2. Agent calls tool&#xa;with order items">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="backend" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#81C784;strokeColor=#2E7D32;strokeWidth=2;fontSize=12;fontStyle=1" value="&lt;font style=&quot;font-size: 14px;&quot;&gt;FastAPI Backend&lt;br&gt;(Webhook Handler)&lt;/font&gt;" vertex="1">
          <mxGeometry height="80" width="140" x="400" y="140" as="geometry" />
        </mxCell>
        <mxCell id="arrow3" edge="1" parent="1" source="tool_box" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#388E3C;" target="backend" value="&lt;font style=&quot;font-size: 14px;&quot;&gt;3. HTTP POST&lt;br&gt;{items: [{name, qty}]}&lt;/font&gt;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="supabase_menu" parent="1" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#4DB6AC;strokeColor=#00695C;strokeWidth=2;fontSize=11;fontStyle=1" value="&lt;font style=&quot;font-size: 14px;&quot;&gt;Supabase&lt;br&gt;menu_items table&lt;br&gt;(laddition_product_id)&lt;/font&gt;" vertex="1">
          <mxGeometry height="100" width="160" x="610" y="290" as="geometry" />
        </mxCell>
        <mxCell id="arrow4" edge="1" parent="1" source="backend" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#00796B;" target="supabase_menu" value="4. Query:&#xa;SELECT laddition_product_id&#xa;WHERE item_name = &#39;Tapas&#39;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="laddition" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FF8A65;strokeColor=#BF360C;strokeWidth=2;fontSize=12;fontStyle=1" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;L&#39;Addition POS&lt;br&gt;POST /med/order&lt;br&gt;(Kitchen Display)&lt;/font&gt;" vertex="1">
          <mxGeometry height="80" width="150" x="1150" y="150" as="geometry" />
        </mxCell>
        <mxCell id="arrow5" edge="1" parent="1" source="backend" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#D84315;fontStyle=1" target="laddition" value="5&lt;font style=&quot;font-size: 14px;&quot;&gt;. POST /med/order&lt;br&gt;{orderLines: [{&lt;br&gt;  idProduct: &#39;U52E3-278515&#39;,&lt;br&gt;  name: &#39;Tapas&#39;, price: 2&lt;br&gt;}]}&lt;/font&gt;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow6" edge="1" parent="1" source="laddition" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#4CAF50;dashed=1;" target="backend" value="6. 200 OK">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="900" y="190" />
              <mxPoint x="900" y="180" />
            </Array>
            <mxPoint x="670" y="200" as="sourcePoint" />
            <mxPoint x="540" y="200" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4oXmpRvjLXMRXj3nHEiX-7" connectable="0" parent="arrow6" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" value="Text" vertex="1">
          <mxGeometry relative="1" x="-0.0613" y="8" as="geometry">
            <mxPoint x="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4oXmpRvjLXMRXj3nHEiX-8" connectable="0" parent="arrow6" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" value="Text" vertex="1">
          <mxGeometry relative="1" x="0.029" y="-4" as="geometry">
            <mxPoint x="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="kitchen_note" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCCBC;strokeColor=#E64A19;strokeWidth=1;fontSize=10;align=center;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Order appears on&lt;br&gt;restaurant&#39;s POS&lt;br&gt;terminal &amp;amp; kitchen&lt;br&gt;display in real-time&lt;/font&gt;" vertex="1">
          <mxGeometry height="120" width="190" x="1370" y="110" as="geometry" />
        </mxCell>
        <mxCell id="phase2_bg" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=2;dashed=1;dashPattern=8 8;" value="" vertex="1">
          <mxGeometry height="1090" width="1840" x="50" y="480" as="geometry" />
        </mxCell>
        <mxCell id="phase2_title" parent="1" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1" value="PHASE 2: POST-CALL WEBHOOK (Data Storage, Payment, SMS)" vertex="1">
          <mxGeometry height="30" width="500" x="60" y="450" as="geometry" />
        </mxCell>
        <mxCell id="elevenlabs_webhook" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#B39DDB;strokeColor=#4527A0;strokeWidth=2;fontSize=12;fontStyle=1" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;ElevenLabs&lt;br&gt;Post-Call Webhook&lt;/font&gt;" vertex="1">
          <mxGeometry height="80" width="150" x="90" y="550" as="geometry" />
        </mxCell>
        <mxCell id="edge_function" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#4DD0E1;strokeColor=#006064;strokeWidth=2;fontSize=12;fontStyle=1" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Supabase Edge Function&lt;br&gt;elevenlabs-webhook&lt;/font&gt;" vertex="1">
          <mxGeometry height="90" width="180" x="280" y="540" as="geometry" />
        </mxCell>
        <mxCell id="sig_verify" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF59D;strokeColor=#F9A825;strokeWidth=2;fontSize=10;align=left;spacingLeft=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;8. Verify Signature&lt;br&gt;• Parse elevenlabs-signature header&lt;br&gt;• Extract timestamp &amp;amp; signature&lt;br&gt;• Check timestamp &amp;lt; 5 mins&lt;br&gt;• Compute HMAC-SHA256&lt;br&gt;• Compare signatures&lt;/font&gt;" vertex="1">
          <mxGeometry height="240" width="260" x="130" y="760" as="geometry" />
        </mxCell>
        <mxCell id="arrow8" edge="1" parent="1" source="edge_function" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#F57C00;dashed=1;" target="sig_verify" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="idempotency" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C5E1A5;strokeColor=#558B2F;strokeWidth=2;fontSize=10;align=left;spacingLeft=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;9. Check Idempotency&lt;br&gt;• Generate key:&lt;br&gt;  elevenlabs_{conversation_id}&lt;br&gt;• Query webhook_logs table&lt;br&gt;• If already processed → return 200&lt;/font&gt;" vertex="1">
          <mxGeometry height="140" width="250" x="520" y="510" as="geometry" />
        </mxCell>
        <mxCell id="arrow9" edge="1" parent="1" source="sig_verify" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#689F38;" target="idempotency" value="&lt;font style=&quot;font-size: 14px;&quot;&gt;✓ Verified&lt;/font&gt;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="webhook_log" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BCAAA4;strokeColor=#5D4037;strokeWidth=2;fontSize=10;align=left;spacingLeft=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;10. Create Webhook Log&lt;br&gt;• Insert into webhook_logs&lt;br&gt;• Store full payload&lt;br&gt;• Status: &#39;processing&#39;&lt;/font&gt;" vertex="1">
          <mxGeometry height="140" width="200" x="500" y="700" as="geometry" />
        </mxCell>
        <mxCell id="arrow10" edge="1" parent="1" source="idempotency" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#6D4C41;" target="webhook_log" value="✓ Not duplicate">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="extract_data" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#90CAF9;strokeColor=#1565C0;strokeWidth=2;fontSize=10;align=left;spacingLeft=10;" value="&lt;font style=&quot;font-size: 14px;&quot;&gt;11. Extract Data from Payload&lt;br&gt;• extractVoiceCallRecord()&lt;br&gt;  - conversation_id, caller_number&lt;br&gt;  - duration, transcript, summary&lt;br&gt;• extractOrderFromTranscript()&lt;br&gt;  - customer_name, phone, items&lt;br&gt;  - total_order_value&lt;br&gt;• extractLatencyMetrics()&lt;br&gt;  - LLM TTFB, TTS TTFB&lt;br&gt;  - token counts, turn metrics&lt;/font&gt;" vertex="1">
          <mxGeometry height="180" width="260" x="890" y="510" as="geometry" />
        </mxCell>
        <mxCell id="arrow11" edge="1" parent="1" source="webhook_log" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#1976D2;" target="extract_data" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="supabase_db" parent="1" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#4DB6AC;strokeColor=#00695C;strokeWidth=2;fontSize=14;fontStyle=1" value="Supabase Database" vertex="1">
          <mxGeometry height="270" width="180" x="1650" y="550" as="geometry" />
        </mxCell>
        <mxCell id="db_tables" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E0F2F1;strokeColor=#00796B;strokeWidth=1;fontSize=10;align=left;spacingLeft=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Tables:&lt;br&gt;• voice_calls&lt;br&gt;• orders&lt;br&gt;• order_items&lt;br&gt;• customers&lt;br&gt;• latency_metrics&lt;br&gt;• webhook_logs&lt;/font&gt;" vertex="1">
          <mxGeometry height="190" width="160" x="1660" y="600" as="geometry" />
        </mxCell>
        <mxCell id="arrow12" edge="1" parent="1" source="extract_data" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#00897B;fontStyle=1" target="supabase_db" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;12. Insert Records&lt;br&gt;• voice_calls (call_id, transcript)&lt;br&gt;• latency_metrics (ttfb_ms, tokens)&lt;br&gt;• customers (upsert by phone)&lt;br&gt;• orders (order_id, total_value)&lt;br&gt;• order_items (name, qty, price)&lt;/font&gt;">
          <mxGeometry relative="1" x="0.2925" y="55" as="geometry">
            <mxPoint x="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="arrow13" edge="1" parent="1" source="extract_data" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#388E3C;" target="stripe" value="13. Create Payment Link&#xa;POST /v1/payment_links&#xa;{line_items: [{&#xa;  product_data: {name},&#xa;  unit_amount: total * 100&#xa;}]}">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="890" y="750" />
              <mxPoint x="1150" y="750" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="stripe_response" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;strokeWidth=1;fontSize=10;align=left;spacingLeft=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;14. Returns:&lt;br&gt;{url: &#39;https://pay.stripe.com/...&#39;}&lt;br&gt;&lt;br&gt;Update orders table:&lt;br&gt;SET payment_link = url&lt;/font&gt;" vertex="1">
          <mxGeometry height="140" width="230" x="1370" y="770" as="geometry" />
        </mxCell>
        <mxCell id="arrow14" edge="1" parent="1" source="stripe" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#66BB6A;dashed=1;" target="stripe_response" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="twilio" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#EF9A9A;strokeColor=#C62828;strokeWidth=2;fontSize=12;fontStyle=1" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Twilio API&lt;br&gt;Send SMS&lt;/font&gt;" vertex="1">
          <mxGeometry height="60" width="140" x="1100" y="1030" as="geometry" />
        </mxCell>
        <mxCell id="arrow15" edge="1" parent="1" source="stripe" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#D32F2F;" target="twilio" value="&lt;font style=&quot;font-size: 14px;&quot;&gt;15. Send SMS&lt;br&gt;POST /Accounts/{sid}/Messages.json&lt;br&gt;{To: customer_phone,&lt;br&gt; From: twilio_number,&lt;br&gt; Body: &#39;Thank you! Total: $X.&lt;br&gt;        Pay here: {payment_link}&#39;}&lt;/font&gt;">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="890" y="750" />
              <mxPoint x="1150" y="750" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="customer_sms" parent="1" style="shape=actor;whiteSpace=wrap;html=1;fillColor=#FFE082;strokeColor=#F57F17;strokeWidth=2;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Customer&lt;br&gt;Receives SMS&lt;/font&gt;" vertex="1">
          <mxGeometry height="90" width="100" x="1470" y="960" as="geometry" />
        </mxCell>
        <mxCell id="arrow16" edge="1" parent="1" source="twilio" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#E53935;" target="customer_sms" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;16. SMS Delivered&lt;/font&gt;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="mark_processed" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BCAAA4;strokeColor=#5D4037;strokeWidth=2;fontSize=10;align=left;spacingLeft=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;17. Mark Webhook Processed&lt;br&gt;• Update webhook_logs&lt;br&gt;• Status: &#39;success&#39;&lt;br&gt;• Store order_id&lt;br&gt;• Increment agent_call_count&lt;/font&gt;" vertex="1">
          <mxGeometry height="170" width="240" x="1060" y="1280" as="geometry" />
        </mxCell>
        <mxCell id="arrow17" edge="1" parent="1" source="twilio" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#6D4C41;" target="mark_processed" value="">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1150" y="1010" />
              <mxPoint x="1180" y="1010" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="final_response" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#A5D6A7;strokeColor=#2E7D32;strokeWidth=2;fontSize=10;align=left;spacingLeft=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;18. Return Response&lt;br&gt;{success: true,&lt;br&gt; conversation_id,&lt;br&gt; order_id,&lt;br&gt; payment_link,&lt;br&gt; request_id}&lt;/font&gt;" vertex="1">
          <mxGeometry height="140" width="210" x="160" y="1090" as="geometry" />
        </mxCell>
        <mxCell id="arrow18" edge="1" parent="1" source="mark_processed" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#388E3C;dashed=1;" target="final_response" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="error_box" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;strokeWidth=2;fontSize=10;align=left;spacingLeft=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Error Handling&lt;br&gt;• Catch all exceptions&lt;br&gt;• Mark webhook as &#39;failed&#39;&lt;br&gt;• Store error_message&lt;br&gt;• Return 500 with details&lt;/font&gt;" vertex="1">
          <mxGeometry height="170" width="220" x="540" y="1060" as="geometry" />
        </mxCell>
        <mxCell id="legend_bg" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#9E9E9E;strokeWidth=1;" value="" vertex="1">
          <mxGeometry height="580" width="660" x="1210" y="1760" as="geometry" />
        </mxCell>
        <mxCell id="legend_title" parent="1" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Legend &amp;amp; Key Components&lt;/font&gt;" vertex="1">
          <mxGeometry height="30" width="300" x="1400" y="1785" as="geometry" />
        </mxCell>
        <mxCell id="legend1" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#B39DDB;strokeColor=#4527A0;strokeWidth=1;fontSize=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;ElevenLabs Components&lt;/font&gt;" vertex="1">
          <mxGeometry height="55" width="140" x="1450" y="1870" as="geometry" />
        </mxCell>
        <mxCell id="legend2" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#81C784;strokeColor=#2E7D32;strokeWidth=1;fontSize=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Backend/API&lt;/font&gt;" vertex="1">
          <mxGeometry height="50" width="140" x="1630" y="1875" as="geometry" />
        </mxCell>
        <mxCell id="legend3" parent="1" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=5;fillColor=#4DB6AC;strokeColor=#00695C;strokeWidth=1;fontSize=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Supabase Database&lt;/font&gt;" vertex="1">
          <mxGeometry height="60" width="140" x="1260" y="1860" as="geometry" />
        </mxCell>
        <mxCell id="legend4" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FF8A65;strokeColor=#BF360C;strokeWidth=1;fontSize=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;L&#39;Addition POS&lt;/font&gt;" vertex="1">
          <mxGeometry height="40" width="140" x="1650" y="1970" as="geometry" />
        </mxCell>
        <mxCell id="legend5" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#A5D6A7;strokeColor=#2E7D32;strokeWidth=1;fontSize=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Stripe Payment&lt;/font&gt;" vertex="1">
          <mxGeometry height="45" width="140" x="1260" y="1960" as="geometry" />
        </mxCell>
        <mxCell id="legend6" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#EF9A9A;strokeColor=#C62828;strokeWidth=1;fontSize=10;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Twilio SMS&lt;/font&gt;" vertex="1">
          <mxGeometry height="40" width="140" x="1460" y="1970" as="geometry" />
        </mxCell>
        <mxCell id="legend_notes" parent="1" style="text;html=1;strokeColor=#757575;fillColor=#EEEEEE;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=10;spacingLeft=10;spacingTop=5;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Key Features:&lt;br&gt;• Signature verification (HMAC-SHA256)&lt;br&gt;• Idempotency (prevent duplicates)&lt;br&gt;• Product ID mapping via Supabase&lt;br&gt;• Real-time order to POS&lt;br&gt;• Automated payment links&lt;br&gt;• SMS confirmations&lt;br&gt;• Comprehensive metrics tracking&lt;/font&gt;" vertex="1">
          <mxGeometry height="240" width="425" x="1317.5" y="2060" as="geometry" />
        </mxCell>
        <mxCell id="env_vars" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=2;fontSize=10;align=left;spacingLeft=10;spacingTop=5;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Required Environment Variables:&lt;br&gt;• ELEVENLABS_WEBHOOK_SECRET&lt;br&gt;• SUPABASE_URL&lt;br&gt;• SUPABASE_SERVICE_ROLE_KEY&lt;br&gt;• STRIPE_SECRET_KEY&lt;br&gt;• TWILIO_ACCOUNT_SID&lt;br&gt;• TWILIO_AUTH_TOKEN&lt;br&gt;• TWILIO_FROM_NUMBER&lt;br&gt;• LADDITION_BEARER_TOKEN&lt;br&gt;• LADDITION_CUSTOMER_ID&lt;/font&gt;" vertex="1">
          <mxGeometry height="260" width="460" x="50" y="2010" as="geometry" />
        </mxCell>
        <mxCell id="flow_summary" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1565C0;strokeWidth=2;fontSize=10;align=left;spacingLeft=10;spacingTop=5;" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Data Flow Summary:&lt;br&gt;1. Customer calls → ElevenLabs agent takes order&lt;br&gt;2. Agent calls custom tool → Backend receives items&lt;br&gt;3. Backend queries Supabase for L&#39;Addition product IDs&lt;br&gt;4. Backend sends order to L&#39;Addition POS (real-time)&lt;br&gt;5. Call ends → ElevenLabs sends post-call webhook&lt;br&gt;6. Edge function verifies signature &amp;amp; checks idempotency&lt;br&gt;7. Extracts call data, order, metrics from payload&lt;br&gt;8. Stores all data in Supabase tables&lt;br&gt;9. Creates Stripe payment link for the order&lt;br&gt;10. Sends SMS to customer with payment link&lt;br&gt;11. Marks webhook as processed&lt;/font&gt;" vertex="1">
          <mxGeometry height="330" width="490" x="580" y="1990" as="geometry" />
        </mxCell>
        <mxCell id="4oXmpRvjLXMRXj3nHEiX-5" edge="1" parent="1" source="phase2_bg" style="endArrow=classic;html=1;rounded=0;" target="phase2_bg" value="">
          <mxGeometry height="50" relative="1" width="50" as="geometry">
            <mxPoint x="140" y="700" as="sourcePoint" />
            <mxPoint x="190" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4oXmpRvjLXMRXj3nHEiX-6" edge="1" parent="1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#D32F2F;" value="">
          <mxGeometry relative="1" as="geometry">
            <Array as="points" />
            <mxPoint x="1040" y="730" as="sourcePoint" />
            <mxPoint x="1150" y="910" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="stripe" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#A5D6A7;strokeColor=#2E7D32;strokeWidth=2;fontSize=12;fontStyle=1" value="Stripe API&#xa;Create Payment Link" vertex="1">
          <mxGeometry height="60" width="140" x="1040" y="870" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
